(window.webpackJsonp=window.webpackJsonp||[]).push([[8,16,28],{22:function(t,e,n){"use strict";n.r(e),n.d(e,"RecordData",(function(){return o})),n.d(e,"RecordInfo",(function(){return i})),n.d(e,"recordListReducer",(function(){return d}));var a=n(15),r=n(45);class o{constructor(){this.add=void 0,this.remove=void 0,this.modify=void 0}}const c=async({type:t,data:e})=>{switch(t){case"add":e=e,await a.a.remove(e.canvasPath,{isFile:!0});break;case"modify":const{fromCanvasPath:t,toCanvasPath:n}=e;await Promise.all([a.a.remove(t,{isFile:!0}),a.a.remove(n,{isFile:!0})]);break;case"remove":const{canvasPath:r}=e;await a.a.remove(r,{isFile:!0})}};class i{constructor(t,e){this.type=t,this.data=e}}const s=async(t,e)=>{const{type:n,data:o}=t;if("add"!==n)if("modify"!==n)if("remove"!==n);else{const{index:t}=o;e.removeLayerByIndex(t,"history")}else{const{index:t,fromCanvasPath:n,toCanvasPath:c}=o,[i]=await a.a.get(c,{isDir:!1}),s=await Object(r.c)(i),d=e.setLayerContent(t,s,"history");e.focusLayer(d)}else{const{index:t,canvasPath:n}=o,[c]=await a.a.get(n,{isDir:!1}),i=await Object(r.c)(c),s=e.addLayerContent(t,i,"history");e.focusLayer(s)}},d=({cursor:t,recorderList:e},{type:n,payload:a,pCanvasController:r})=>{switch(n){case"add":if(t<e.length-1){e.splice(Math.max(t,0)).map(t=>c(t))}if(100<=e.length){e.splice(0,e.length-100+1).map(t=>c(t))}t++,a&&e.push(a);break;case"redo":if(++t<=e.length-1){const n=e[t];r&&s(n,r)}break;case"undo":if(t>-1){const n=e[t];r&&s((({type:t,data:e})=>{if("add"===t){const{index:t,canvasPath:n}=e;return new i("remove",{index:t,canvasPath:n})}if("modify"===t){const{index:t,fromCanvasPath:n,toCanvasPath:a}=e;return new i("modify",{index:t,fromCanvasPath:a,toCanvasPath:n})}const{index:n,canvasPath:a}=e;return new i("add",{index:n,canvasPath:a})})(n),r)}t--}return{cursor:Math.max(Math.min(t,e.length-1),-1),recorderList:e}}},36:function(t,e,n){t.exports={recordBtn:"recordBtn_81954",recordBtnActive:"recordBtnActive_a74d3"}},4:function(t,e,n){"use strict";n.r(e);var a=n(46),r=n.n(a),o=n(0),c=n.n(o),i=n(1),s=n(36),d=n.n(s),u=n(45),f=n(22),l=n(15);const h=async t=>{const e=`record_${Date.now()}_${r()()}.png`,n=await Object(u.e)(t),a=`record/${e}`;return n&&await l.a.save({type:"image/png",data:n,path:a}),a};e.default=({pCanvasController:t})=>{const[{cursor:e,recorderList:n},a]=Object(o.useReducer)(f.recordListReducer,{cursor:-1,recorderList:[]}),r=e>=0,s=e<n.length-1;Object(o.useEffect)(()=>{const e=async t=>{const{data:{layerDetail:{canvas:e},index:n},tag:r}=t;if("history"===r)return;const o=await h(e);a({type:"add",payload:new f.RecordInfo("add",{index:n,canvasPath:o})})},n=async t=>{const{data:{layerDetail:{canvas:e},preContent:n,index:r},tag:o}=t;"history"!==o&&a({type:"add",payload:new f.RecordInfo("modify",{index:r,fromCanvasPath:await h(n),toCanvasPath:await h(e)})})},r=async t=>{const{data:{layerDetail:{canvas:e},index:n},tag:r}=t;if("history"===r)return;const o=await h(e);a({type:"add",payload:new f.RecordInfo("remove",{index:n,canvasPath:o})})};return t.on("addLayer",e),t.on("contentChange",n),t.on("removeLayer",r),()=>{t.off("addLayer",e),t.off("contentChange",n),t.off("removeLayer",r),l.a.remove("record")}},[]);return c.a.createElement(o.Fragment,null,c.a.createElement("span",{className:`${d.a.recordBtn} ${s&&d.a.recordBtnActive||""} `,onPointerUp:s&&(()=>{a({type:"redo",pCanvasController:t})})||void 0},"redo"),c.a.createElement(i.Divider,null),c.a.createElement("span",{className:`${d.a.recordBtn} ${r&&d.a.recordBtnActive||""}`,onPointerUp:r&&(()=>{a({type:"undo",pCanvasController:t})})||void 0},"undo"))}},45:function(t,e,n){"use strict";n.d(e,"b",(function(){return o})),n.d(e,"a",(function(){return c})),n.d(e,"c",(function(){return d})),n.d(e,"e",(function(){return u})),n.d(e,"d",(function(){return l}));var a=n(46),r=n.n(a);const o=(t=0,e=0,n)=>{const a=document.createElement("canvas");a.width=t,a.height=e,a.setAttribute("uuid",r()("canvasId-"));const o=a.getContext("2d");return o&&n&&(o.fillStyle=n.toRGBAString(),o.fillRect(0,0,t,e)),a},c=t=>{const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const n=e.getContext("2d");return n&&(n.imageSmoothingEnabled=!1,n.clearRect(0,0,e.width,e.height),n.drawImage(t,0,0,t.width,t.height)),e},i=[];let s=0;const d=async t=>new Promise(e=>{i.push({file:t,cb:e}),(async()=>{if(s<1){let t=i.shift();for(;t;){s++;const{file:e,cb:n}=t,a=new Image;a.src=URL.createObjectURL(e);try{await a.decode()}catch(t){}URL.revokeObjectURL(a.src),n(a),s--,t=i.shift()}}})()}),u=t=>new Promise(e=>{t.toBlob(e,"image/png",1)});let f=()=>{const t=o(0,0).toDataURL();return f=()=>t,f()};const l=()=>f()},46:function(t,e,n){var a=n(52),r=0;t.exports=function(t){var e=++r;return a(t)+e}},47:function(t,e,n){var a=n(49),r="object"==typeof self&&self&&self.Object===Object&&self,o=a||r||Function("return this")();t.exports=o},48:function(t,e){t.exports=function(){return!1}},49:function(t,e,n){(function(e){var n="object"==typeof e&&e&&e.Object===Object&&e;t.exports=n}).call(this,n(50))},50:function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},51:function(t,e){var n=Array.isArray;t.exports=n},52:function(t,e,n){var a=n(53);t.exports=function(t){return null==t?"":a(t)}},53:function(t,e,n){var a=n(54),r=n(55),o=n(51),c=n(48),i=a?a.prototype:void 0,s=i?i.toString:void 0;t.exports=function t(e){if("string"==typeof e)return e;if(o(e))return r(e,t)+"";if(c(e))return s?s.call(e):"";var n=e+"";return"0"==n&&1/e==-1/0?"-0":n}},54:function(t,e,n){var a=n(47).Symbol;t.exports=a},55:function(t,e){t.exports=function(t,e){for(var n=-1,a=null==t?0:t.length,r=Array(a);++n<a;)r[n]=e(t[n],n,t);return r}}}]);